name: 推荐友链处理

on:
    issues:
        types: [labeled]

jobs:
    add-recommended:
        if: github.event.label.name == 'recommended' && contains(github.event.issue.labels.*.name, '友链申请') && github.event.issue.state == 'closed'
        runs-on: ubuntu-latest
        permissions:
            issues: read
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Parse issue content
              id: parse
              uses: actions/github-script@v7
              with:
                  script: |
                      const body = context.payload.issue.body;

                      function extractValue(text, label) {
                        const regex = new RegExp(`###\\s*${label}[\\s\\S]*?\\n\\s*(.+?)(?:\\n|$)`, 'i');
                        const match = text.match(regex);
                        if (match) {
                          let value = match[1].trim();
                          value = value.replace(/^`+|`+$/g, '');
                          return value;
                        }
                        return '';
                      }

                      const name = extractValue(body, '网站名称');
                      const url = extractValue(body, '网站地址');

                      console.log('Target friend link:');
                      console.log('  Name:', name);
                      console.log('  URL:', url);

                      core.setOutput('name', name);
                      core.setOutput('url', url);

            - name: Add recommended field
              uses: actions/github-script@v7
              env:
                  NAME: ${{ steps.parse.outputs.name }}
                  URL: ${{ steps.parse.outputs.url }}
              with:
                  script: |
                      const fs = require('fs');
                      const name = process.env.NAME;
                      const url = process.env.URL;
                      const filePath = 'data/friends.ts';

                      let content = fs.readFileSync(filePath, 'utf8');
                      const lines = content.split('\n');
                      let result = [];
                      let inTargetBlock = false;
                      let hasRecommended = false;
                      let found = false;

                      for (let i = 0; i < lines.length; i++) {
                        const line = lines[i];
                        
                        if (line.includes(`name: "${name}"`)) {
                          inTargetBlock = true;
                        }
                        
                        if (inTargetBlock) {
                          if (line.includes(`url: "${url}"`)) {
                            found = true;
                          }
                          if (line.includes('recommended:')) {
                            hasRecommended = true;
                          }
                          if (line.includes('},') || line.includes('}')) {
                            if (found && !hasRecommended) {
                              const lastLine = result[result.length - 1];
                              const indent = lastLine ? lastLine.match(/^(\s*)/)[1] : '        ';
                              result.push(`${indent}recommended: true`);
                            }
                            inTargetBlock = false;
                            found = false;
                            hasRecommended = false;
                          }
                        }
                        
                        result.push(line);
                      }

                      fs.writeFileSync(filePath, result.join('\n'));
                      console.log('Recommended field added!');

            - name: Commit changes
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  git add data/friends.ts
                  git diff --staged --quiet || git commit -m "设置推荐友链: ${{ steps.parse.outputs.name }}"
                  git push
