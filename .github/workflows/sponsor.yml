name: Sponsor Workflow

on:
  issues:
    types: [closed, labeled]

permissions:
  issues: write
  contents: write

jobs:
  validate-and-add-sponsor:
    if: contains(github.event.issue.labels.*.name, 'sponsor') && contains(github.event.issue.labels.*.name, '确认') && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            const parseField = (label) => {
              const regex = new RegExp(`### ${label}[\\s\\S]*?\\n\\n([\\s\\S]*?)(?=\\n\\n###|$)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const data = {
              name: parseField('您的昵称'),
              avatar: parseField('头像地址'),
              website: parseField('个人网站'),
              date: parseField('捐赠日期'),
              amount: parseField('捐赠金额')
            };
            
            console.log('Parsed data:', JSON.stringify(data, null, 2));
            core.setOutput('name', data.name);
            core.setOutput('avatar', data.avatar);
            core.setOutput('website', data.website);
            core.setOutput('date', data.date);
            core.setOutput('amount', data.amount);
            core.setOutput('data', JSON.stringify(data));

      - name: Validate URLs
        id: validate
        env:
          AVATAR: ${{ steps.parse.outputs.avatar }}
          WEBSITE: ${{ steps.parse.outputs.website }}
        run: |
          validate_url() {
            local url=$1
            local field=$2
            local success=0
            
            if [ -z "$url" ]; then
              echo "No $field provided, skipping validation"
              echo "failed_$field=0" >> $GITHUB_OUTPUT
              return 0
            fi
            
            if ! [[ "$url" =~ ^https?:// ]]; then
              echo "Invalid URL format for $field: $url"
              echo "failed_$field=1" >> $GITHUB_OUTPUT
              echo "error_$field=$field URL 格式无效: $url" >> $GITHUB_OUTPUT
              return 1
            fi
            
            echo "Testing $field: $url"
            
            for i in 1 2 3; do
              echo "Attempt $i for $field..."
              if curl -sSf --connect-timeout 10 --max-time 30 -o /dev/null "$url"; then
                echo "✓ $field is accessible (attempt $i)"
                success=1
                break
              else
                echo "✗ $field failed (attempt $i)"
                sleep 2
              fi
            done
            
            if [ $success -eq 0 ]; then
              echo "failed_$field=1" >> $GITHUB_OUTPUT
              echo "error_$field=$field URL 无法访问: $url" >> $GITHUB_OUTPUT
              return 1
            else
              echo "failed_$field=0" >> $GITHUB_OUTPUT
              return 0
            fi
          }
          
          avatar_failed=0
          website_failed=0
          errors=""
          
          if ! validate_url "$AVATAR" "avatar"; then
            avatar_failed=1
            errors="${errors}头像地址 (avatar) 无法访问: $AVATAR\n"
          fi
          
          if [ -n "$WEBSITE" ]; then
            if ! validate_url "$WEBSITE" "website"; then
              website_failed=1
              errors="${errors}个人网站 (website) 无法访问: $WEBSITE\n"
            fi
          fi
          
          echo "avatar_failed=$avatar_failed" >> $GITHUB_OUTPUT
          echo "website_failed=$website_failed" >> $GITHUB_OUTPUT
          
          if [ $avatar_failed -eq 1 ] || [ $website_failed -eq 1 ]; then
            echo "validation_passed=false" >> $GITHUB_OUTPUT
            echo -e "$errors" > /tmp/errors.txt
          else
            echo "validation_passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Reopen issue on validation failure
        if: steps.validate.outputs.validation_passed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const errors = fs.readFileSync('/tmp/errors.txt', 'utf8');
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'open'
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ❌ 捐赠信息验证失败\n\n以下字段验证未通过：\n\n\`\`\`\n${errors}\`\`\`\n\n请检查并修正上述问题后重新提交。`
            });

      - name: Add sponsor to file
        if: steps.validate.outputs.validation_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const newSponsor = {
              name: '${{ steps.parse.outputs.name }}',
              avatar: '${{ steps.parse.outputs.avatar }}',
              date: '${{ steps.parse.outputs.date }}',
              amount: '${{ steps.parse.outputs.amount }}'
            };
            
            const website = '${{ steps.parse.outputs.website }}';
            if (website) {
              newSponsor.website = website;
            }
            
            const filePath = 'data/sponsors.json';
            const content = fs.readFileSync(filePath, 'utf8');
            const sponsors = JSON.parse(content);
            
            sponsors.unshift(newSponsor);
            
            fs.writeFileSync(filePath, JSON.stringify(sponsors, null, '\t'));
            
            console.log('Added sponsor:', JSON.stringify(newSponsor, null, 2));

      - name: Commit and push changes
        if: steps.validate.outputs.validation_passed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/sponsors.json
          git commit -m "Add sponsor: ${{ steps.parse.outputs.name }}"
          git push

      - name: Comment on success
        if: steps.validate.outputs.validation_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ✅ 捐赠信息添加成功\n\n感谢您的捐赠！您的信息已成功添加到捐赠列表中。\n\n- **昵称**: ${{ steps.parse.outputs.name }}\n- **捐赠金额**: ${{ steps.parse.outputs.amount }}\n- **捐赠日期**: ${{ steps.parse.outputs.date }}`
            });
