name: 友链检测

on:
    schedule:
        - cron: "0 0 * * *"
    workflow_dispatch:

jobs:
    check-links:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            issues: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install dependencies
              run: npm install

            - name: Run link checker
              id: check
              run: npm run check-links
              continue-on-error: true

            - name: Check for disconnected links
              id: check_disconnected
              run: |
                  if [ -f "disconnected.json" ]; then
                    echo "has_disconnected=true" >> $GITHUB_OUTPUT
                    echo "Disconnected links found:"
                    cat disconnected.json
                  else
                    echo "has_disconnected=false" >> $GITHUB_OUTPUT
                  fi

            - name: Find and reopen issues for disconnected links
              if: steps.check_disconnected.outputs.has_disconnected == 'true'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const disconnectedList = JSON.parse(fs.readFileSync('disconnected.json', 'utf8'));

                      for (const item of disconnectedList) {
                        const issues = await github.rest.issues.listForRepo({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          state: 'all',
                          per_page: 100
                        });
                        
                        let foundIssue = issues.data.find(issue => 
                          issue.body && issue.body.includes(item.url) && issue.body.includes('网站名称')
                        );
                        
                        if (foundIssue) {
                          if (foundIssue.state === 'closed') {
                            await github.rest.issues.update({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number: foundIssue.number,
                              state: 'open'
                            });
                          }
                          
                          await github.rest.issues.createComment({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number: foundIssue.number,
                            body: `⚠️ **友链检测失败**\n\n**网站名称**: ${item.name}\n**网站地址**: ${item.url}\n**失败原因**: ${item.reason}\n\n该友链已被标记为失联状态。请检查网站是否正常，修复后关闭此议题将自动移除失联标记。`
                          });
                          
                          console.log(`Reopened issue #${foundIssue.number} for ${item.name}`);
                        } else {
                          const newIssue = await github.rest.issues.create({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            title: `友链失联: ${item.name}`,
                            body: `### 网站名称\n\n${item.name}\n\n### 网站地址\n\n${item.url}\n\n---\n\n⚠️ 此议题由友链检测自动创建。\n\n**失败原因**: ${item.reason}`
                          });
                          console.log(`Created issue #${newIssue.data.number} for ${item.name}`);
                        }
                      }

            - name: Check for changes
              id: changes
              run: |
                  if git diff --quiet data/friends.ts; then
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                  else
                    echo "has_changes=true" >> $GITHUB_OUTPUT
                  fi

            - name: Commit changes
              if: steps.changes.outputs.has_changes == 'true'
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  git add data/friends.ts
                  git commit -m "chore: 更新友链状态"
                  git push

            - name: Clean up
              if: always()
              run: |
                  rm -f disconnected.json

            - name: Fail if links are broken
              if: steps.check.outcome == 'failure'
              run: |
                  echo "部分友链检测失败，请查看日志了解详情"
                  exit 1
