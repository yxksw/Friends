name: 赞助名单处理

on:
    issues:
        types: [closed, labeled]

jobs:
    process-sponsor:
        if: contains(github.event.issue.body, '赞助日期') && contains(github.event.issue.body, '赞助金额') && contains(github.event.issue.labels.*.name, '通过') && github.event.issue.state == 'closed'
        runs-on: ubuntu-latest
        permissions:
            issues: read
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Parse issue content
              id: parse
              uses: actions/github-script@v7
              with:
                  script: |
                      const body = context.payload.issue.body;

                      function extractValue(text, label) {
                        const regex = new RegExp(`###\\s*${label}[\\s\\S]*?\\n\\s*(.+?)(?:\\n|$)`, 'i');
                        const match = text.match(regex);
                        if (match) {
                          let value = match[1].trim();
                          value = value.replace(/^`+|`+$/g, '');
                          return value;
                        }
                        return '';
                      }

                      const name = extractValue(body, '名称');
                      const avatar = extractValue(body, '头像地址');
                      const website = extractValue(body, '网站地址');
                      const date = extractValue(body, '赞助日期');
                      const amount = extractValue(body, '赞助金额');

                      console.log('Parsed values:');
                      console.log('  Name:', name);
                      console.log('  Avatar:', avatar);
                      console.log('  Website:', website);
                      console.log('  Date:', date);
                      console.log('  Amount:', amount);

                      core.setOutput('name', name);
                      core.setOutput('avatar', avatar);
                      core.setOutput('website', website);
                      core.setOutput('date', date);
                      core.setOutput('amount', amount);

            - name: Update sponsors.json
              uses: actions/github-script@v7
              env:
                  NAME: ${{ steps.parse.outputs.name }}
                  AVATAR: ${{ steps.parse.outputs.avatar }}
                  WEBSITE: ${{ steps.parse.outputs.website }}
                  DATE: ${{ steps.parse.outputs.date }}
                  AMOUNT: ${{ steps.parse.outputs.amount }}
              with:
                  script: |
                      const fs = require('fs');
                      const name = process.env.NAME;
                      const avatar = process.env.AVATAR;
                      const website = process.env.WEBSITE;
                      const date = process.env.DATE;
                      const amount = process.env.AMOUNT;
                      const filePath = 'data/sponsors.json';

                      let newEntry = {
                        name: name,
                        avatar: avatar,
                        date: date,
                        amount: amount
                      };

                      if (website) {
                        newEntry.website = website;
                      }

                      let content = JSON.parse(fs.readFileSync(filePath, 'utf8'));
                      content.unshift(newEntry);

                      fs.writeFileSync(filePath, JSON.stringify(content, null, '\t'));
                      console.log('Sponsor added successfully!');

            - name: Commit changes
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  git add data/sponsors.json
                  git commit -m "添加赞助: ${{ steps.parse.outputs.name }}"
                  git push
