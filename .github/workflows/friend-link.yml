name: Friend Link Workflow

on:
  issues:
    types: [closed, labeled]

permissions:
  issues: write
  contents: write

jobs:
  validate-and-add-friend:
    if: contains(github.event.issue.labels.*.name, 'friend-link')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            const parseField = (label) => {
              const regex = new RegExp(`### ${label}[\\s\\S]*?\\n\\n([\\s\\S]*?)(?=\\n\\n###|$)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const data = {
              name: parseField('网站名称'),
              description: parseField('网站描述'),
              url: parseField('网站地址'),
              avatar: parseField('头像地址')
            };
            
            console.log('Parsed data:', JSON.stringify(data, null, 2));
            core.setOutput('name', data.name);
            core.setOutput('description', data.description);
            core.setOutput('url', data.url);
            core.setOutput('avatar', data.avatar);
            core.setOutput('data', JSON.stringify(data));

      - name: Validate URLs
        id: validate
        env:
          URL: ${{ steps.parse.outputs.url }}
          AVATAR: ${{ steps.parse.outputs.avatar }}
        run: |
          validate_url() {
            local url=$1
            local field=$2
            local success=0
            
            echo "Testing $field: $url"
            
            for i in 1 2 3; do
              echo "Attempt $i for $field..."
              if curl -sSf --connect-timeout 10 --max-time 30 -o /dev/null "$url"; then
                echo "✓ $field is accessible (attempt $i)"
                success=1
                break
              else
                echo "✗ $field failed (attempt $i)"
                sleep 2
              fi
            done
            
            if [ $success -eq 0 ]; then
              echo "failed_$field=1" >> $GITHUB_OUTPUT
              echo "error_$field=$field URL 无法访问: $url" >> $GITHUB_OUTPUT
              return 1
            else
              echo "failed_$field=0" >> $GITHUB_OUTPUT
              return 0
            fi
          }
          
          url_failed=0
          avatar_failed=0
          errors=""
          
          if ! validate_url "$URL" "url"; then
            url_failed=1
            errors="${errors}网站地址 (url) 无法访问: $URL\n"
          fi
          
          if ! validate_url "$AVATAR" "avatar"; then
            avatar_failed=1
            errors="${errors}头像地址 (avatar) 无法访问: $AVATAR\n"
          fi
          
          echo "url_failed=$url_failed" >> $GITHUB_OUTPUT
          echo "avatar_failed=$avatar_failed" >> $GITHUB_OUTPUT
          
          if [ $url_failed -eq 1 ] || [ $avatar_failed -eq 1 ]; then
            echo "validation_passed=false" >> $GITHUB_OUTPUT
            echo -e "$errors" > /tmp/errors.txt
          else
            echo "validation_passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Reopen issue on validation failure
        if: steps.validate.outputs.validation_passed == 'false' && github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const errors = fs.readFileSync('/tmp/errors.txt', 'utf8');
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'open'
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ❌ 友链验证失败\n\n以下字段验证未通过：\n\n\`\`\`\n${errors}\`\`\`\n\n请检查并修正上述问题后重新提交。`
            });

      - name: Add friend link to file
        if: steps.validate.outputs.validation_passed == 'true' && github.event.action == 'closed'
        env:
          NAME: ${{ steps.parse.outputs.name }}
          DESCRIPTION: ${{ steps.parse.outputs.description }}
          URL: ${{ steps.parse.outputs.url }}
          AVATAR: ${{ steps.parse.outputs.avatar }}
        run: |
          TODAY=$(date +%Y-%m-%d)
          
          NEW_ENTRY="    {
              name: \"$NAME\",
              description: \"$DESCRIPTION\",
              url: \"$URL\",
              avatar: \"$AVATAR\",
              addDate: \"$TODAY\"
          },"
          
          sed -i "/export const FRIEND_LINKS: FriendLink\[\] = \[/a $NEW_ENTRY" data/friends.ts
          
          cat data/friends.ts

      - name: Commit and push changes
        if: steps.validate.outputs.validation_passed == 'true' && github.event.action == 'closed'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/friends.ts
          git commit -m "Add friend link: ${{ steps.parse.outputs.name }}"
          git push

      - name: Comment on success
        if: steps.validate.outputs.validation_passed == 'true' && github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ✅ 友链添加成功\n\n您的友链已成功添加到列表中！\n\n- **网站名称**: ${{ steps.parse.outputs.name }}\n- **网站地址**: ${{ steps.parse.outputs.url }}`
            });

  add-recommended-label:
    if: github.event.action == 'labeled' && github.event.label.name == '推荐' && contains(github.event.issue.labels.*.name, 'friend-link')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            const parseField = (label) => {
              const regex = new RegExp(`### ${label}[\\s\\S]*?\\n\\n([\\s\\S]*?)(?=\\n\\n###|$)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };
            
            core.setOutput('name', parseField('网站名称'));
            core.setOutput('url', parseField('网站地址'));

      - name: Add recommended field
        env:
          NAME: ${{ steps.parse.outputs.name }}
          URL: ${{ steps.parse.outputs.url }}
        run: |
          if grep -q "url: \"$URL\"" data/friends.ts; then
            sed -i "/url: \"$URL\"/,/}/s/addDate: \"\(.*\)\"/addDate: \"\1\",\n        recommended: true/" data/friends.ts
          fi
          
          cat data/friends.ts

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/friends.ts
          git commit -m "Mark friend link as recommended: ${{ steps.parse.outputs.name }}"
          git push

      - name: Comment on recommendation
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ⭐ 已设为推荐友链\n\n您的友链已被标记为推荐！`
            });
