name: 友链申请处理

on:
    issues:
        types: [closed, labeled]

jobs:
    process-friend-link:
        if: contains(github.event.issue.labels.*.name, '友链申请') && github.event.issue.state == 'closed'
        runs-on: ubuntu-latest
        permissions:
            issues: write
            contents: write

        steps:
            - name: Debug labels
              run: |
                  echo "Issue labels:"
                  echo "${{ toJSON(github.event.issue.labels) }}"
                  echo "Issue state: ${{ github.event.issue.state }}"

            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Parse issue content
              id: parse
              env:
                  ISSUE_BODY: ${{ github.event.issue.body }}
              run: |
                  echo "Parsing issue content..."

                  NAME=$(echo "$ISSUE_BODY" | grep -A1 "### 网站名称" | tail -n1 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//;s/^`//;s/`$//')
                  DESCRIPTION=$(echo "$ISSUE_BODY" | grep -A1 "### 网站描述" | tail -n1 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//;s/^`//;s/`$//')
                  URL=$(echo "$ISSUE_BODY" | grep -A1 "### 网站地址" | tail -n1 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//;s/^`//;s/`$//')
                  AVATAR=$(echo "$ISSUE_BODY" | grep -A1 "### 头像地址" | tail -n1 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//;s/^`//;s/`$//')

                  echo "name=$NAME" >> $GITHUB_OUTPUT
                  echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
                  echo "url=$URL" >> $GITHUB_OUTPUT
                  echo "avatar=$AVATAR" >> $GITHUB_OUTPUT

                  echo "Parsed values:"
                  echo "  Name: $NAME"
                  echo "  Description: $DESCRIPTION"
                  echo "  URL: $URL"
                  echo "  Avatar: $AVATAR"

            - name: Check URL accessibility
              id: check_url
              if: "!contains(github.event.issue.labels.*.name, '手动通过')"
              run: |
                  URL="${{ steps.parse.outputs.url }}"
                  echo "Checking URL: $URL"

                  SUCCESS=false
                  for i in 1 2 3; do
                    echo "Attempt $i..."
                    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 15 --max-time 20 -L \
                      -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
                      -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" \
                      -H "Accept-Language: zh-CN,zh;q=0.9,en;q=0.8" \
                      "$URL" 2>/dev/null)
                    echo "HTTP Code: $HTTP_CODE"
                    
                    if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
                      echo "URL is accessible on attempt $i (HTTP $HTTP_CODE)"
                      SUCCESS=true
                      break
                    elif [ "$HTTP_CODE" -ge 400 ] && [ "$HTTP_CODE" -lt 500 ]; then
                      echo "Client error (HTTP $HTTP_CODE)"
                    elif [ "$HTTP_CODE" -ge 500 ]; then
                      echo "Server error (HTTP $HTTP_CODE)"
                    else
                      echo "Connection failed or timeout"
                    fi
                    sleep 3
                  done

                  if [ "$SUCCESS" = true ]; then
                    echo "url_accessible=true" >> $GITHUB_OUTPUT
                  else
                    echo "url_accessible=false" >> $GITHUB_OUTPUT
                  fi

            - name: Check Avatar accessibility
              id: check_avatar
              if: "!contains(github.event.issue.labels.*.name, '手动通过')"
              run: |
                  AVATAR="${{ steps.parse.outputs.avatar }}"
                  echo "Checking Avatar: $AVATAR"

                  SUCCESS=false
                  for i in 1 2 3; do
                    echo "Attempt $i..."
                    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 15 --max-time 20 -L \
                      -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
                      -H "Accept: image/webp,image/apng,image/*,*/*;q=0.8" \
                      "$AVATAR" 2>/dev/null)
                    echo "HTTP Code: $HTTP_CODE"
                    
                    if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
                      echo "Avatar is accessible on attempt $i (HTTP $HTTP_CODE)"
                      SUCCESS=true
                      break
                    elif [ "$HTTP_CODE" -ge 400 ] && [ "$HTTP_CODE" -lt 500 ]; then
                      echo "Client error (HTTP $HTTP_CODE)"
                    elif [ "$HTTP_CODE" -ge 500 ]; then
                      echo "Server error (HTTP $HTTP_CODE)"
                    else
                      echo "Connection failed or timeout"
                    fi
                    sleep 3
                  done

                  if [ "$SUCCESS" = true ]; then
                    echo "avatar_accessible=true" >> $GITHUB_OUTPUT
                  else
                    echo "avatar_accessible=false" >> $GITHUB_OUTPUT
                  fi

            - name: Validate results
              id: validate
              run: |
                  if [ "${{ contains(github.event.issue.labels.*.name, '手动通过') }}" = "true" ]; then
                    echo "validation_passed=true" >> $GITHUB_OUTPUT
                    echo "Manual approval - skipping URL check"
                  else
                    URL_OK="${{ steps.check_url.outputs.url_accessible }}"
                    AVATAR_OK="${{ steps.check_avatar.outputs.avatar_accessible }}"
                    
                    if [ "$URL_OK" = "true" ] && [ "$AVATAR_OK" = "true" ]; then
                      echo "validation_passed=true" >> $GITHUB_OUTPUT
                    else
                      echo "validation_passed=false" >> $GITHUB_OUTPUT
                      
                      REASON=""
                      if [ "$URL_OK" != "true" ]; then
                        REASON="网站地址无法访问（可能是服务器限制了 GitHub IP，请尝试添加「手动通过」标签）"
                      fi
                      if [ "$AVATAR_OK" != "true" ]; then
                        if [ -n "$REASON" ]; then
                          REASON="$REASON，"
                        fi
                        REASON="${REASON}头像地址无法访问"
                      fi
                      
                      echo "failure_reason=$REASON" >> $GITHUB_OUTPUT
                    fi
                  fi

            - name: Add friend link to file
              if: steps.validate.outputs.validation_passed == 'true'
              env:
                  NAME: ${{ steps.parse.outputs.name }}
                  DESCRIPTION: ${{ steps.parse.outputs.description }}
                  URL: ${{ steps.parse.outputs.url }}
                  AVATAR: ${{ steps.parse.outputs.avatar }}
              run: |
                  ADD_DATE=$(date +%Y-%m-%d)

                  echo "Adding friend link..."
                  echo "  Name: $NAME"
                  echo "  URL: $URL"
                  echo "  Date: $ADD_DATE"

                  FILE_PATH="data/friends.ts"

                  awk -v name="$NAME" -v desc="$DESCRIPTION" -v url="$URL" -v avatar="$AVATAR" -v date="$ADD_DATE" '
                  /^export const FRIEND_LINKS: FriendLink\[\] = \[$/ {
                      print $0
                      print "    {"
                      print "        name: \"" name "\","
                      print "        description: \"" desc "\","
                      print "        url: \"" url "\","
                      print "        avatar: \"" avatar "\","
                      print "        addDate: \"" date "\""
                      print "    },"
                      next
                  }
                  { print }
                  ' "$FILE_PATH" > "$FILE_PATH.tmp" && mv "$FILE_PATH.tmp" "$FILE_PATH"

                  echo "Friend link added successfully!"

            - name: Commit changes
              if: steps.validate.outputs.validation_passed == 'true'
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  git add data/friends.ts
                  git commit -m "添加友链: ${{ steps.parse.outputs.name }}"
                  git push

            - name: Comment success
              if: steps.validate.outputs.validation_passed == 'true'
              uses: actions/github-script@v7
              env:
                  NAME: ${{ steps.parse.outputs.name }}
                  URL: ${{ steps.parse.outputs.url }}
              with:
                  script: |
                      const name = process.env.NAME;
                      const url = process.env.URL;
                      const date = new Date().toISOString().split('T')[0];

                      await github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: `✅ 友链验证通过！已成功添加到友链列表。\n\n**网站名称**: ${name}\n**网站地址**: ${url}\n**添加日期**: ${date}`
                      });

            - name: Reopen issue on failure
              if: steps.validate.outputs.validation_passed != 'true'
              uses: actions/github-script@v7
              env:
                  REASON: ${{ steps.validate.outputs.failure_reason }}
              with:
                  script: |
                      const reason = process.env.REASON;

                      await github.rest.issues.update({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                        state: 'open'
                      });

                      await github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: `❌ 友链验证失败！\n\n**失败原因**: ${reason}\n\n请检查您提交的链接是否正确。如果确认链接无误，管理员可以添加「手动通过」标签后关闭议题。`
                      });
